<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <title>Chatbot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/chatbot.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Open+Sans&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Quicksand&display=swap" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.0.13/js/all.js"></script>
  <link rel="preload" as="image" href="{{ url_for('static', filename='images/gambarhome1.jpg') }}">
  <link rel="preload" as="image" href="{{ url_for('static', filename='images/gambarhome2.jpg') }}">
  <link rel="preload" as="image" href="{{ url_for('static', filename='images/gambarhome3.jpg') }}">
  <link rel="preload" as="image" href="{{ url_for('static', filename='images/gambarhome4.jpg') }}">
  <link rel="preload" as="image" href="{{ url_for('static', filename='images/gambarhome5.jpg') }}">
  <link rel="preload" as="image" href="{{ url_for('static', filename='images/gambarhome6.jpg') }}">
</head>

<body>

  <!-- Header Menu -->
  <header>
    <div><a href="{{ url_for('index') }}" class="logo">SAHABAT ANAK</a></div>
    <nav>
      <a href="{{ url_for('index') }}">Home</a>
      <a href="{{ url_for('tentang') }}">Tentang Website</a>
      <a href="{{ url_for('chatbot') }}" class="active">Sahabat Anak Bot</a>

      <div class="dropdown">
        <a href="#" class="dropbtn">Pages &#9662;</a>
        <div class="dropdown-content">
          <a href="{{ url_for('edukasi') }}">Edukasi</a>
          <a href="{{ url_for('gizi') }}">Gizi dan Nutrisi</a>
          <a href="{{ url_for('pola') }}">Pola Asuh Anak</a>
        </div>
      </div>
    </nav>
  </header>

  <!-- Chatbot Section -->
  <section class="msger">
    <header class="msger-header">
      <div class="msger-header-title">
        SAHABAT ANAK BOT
      </div>
    </header>

    <main class="msger-chat">
      <div class="msg left-msg">
        <div class="msg-img" style="background-image: url('/static/images/profilchatbot.jpg')"></div>
        <div class="msg-bubble">
          <div class="msg-info">
            <div class="msg-info-name">Sahabat Anak</div>
            <div class="msg-info-time" id="chatbot-time"></div>
          </div>
          <div class="msg-text">
            Haloo, Selamat datang di Chatbot Sahabat Anak ðŸ˜„
          </div>
        </div>
      </div>
    </main>

    <!-- Tempat tombol rekomendasi -->
    <div id="recommendations" class="recommendations"></div>

    <form class="msger-inputarea">
      <input type="text" class="msger-input" id="textInput" placeholder="Enter your message...">
      <button type="submit" class="msger-send-btn">Kirim</button>
    </form>
  </section>

  <script>
  function getCurrentTime() {
    const now = new Date();
    let hours = now.getHours();
    let minutes = now.getMinutes();
    if (hours < 10) hours = "0" + hours;
    if (minutes < 10) minutes = "0" + minutes;
    return `${hours}:${minutes}`;
  }

  // pasang waktu ke elemen
  document.getElementById("chatbot-time").textContent = getCurrentTime();
  </script>

  <!-- Script -->
  <script>
  // ----- ELEMENTS -----
  const msgerForm = get(".msger-inputarea");
  const msgerInput = get(".msger-input");
  const msgerChat = get(".msger-chat");
  const recommendationsContainer = document.getElementById("recommendations");

  // ----- CONSTANTS -----
  const BOT_IMG = "/static/images/profilchatbot.jpg";
  const PERSON_IMG = "/static/images/profil.jpg";
  const BOT_NAME = "Sahabat Anak";
  const PERSON_NAME = "Anda";

  // ----- INIT -----
  window.addEventListener("load", () => {
    if (recommendationsContainer) loadRecommendations();
  });

  // ----- RECOMMENDATIONS (awal dari server) -----
  function loadRecommendations() {
    if (!recommendationsContainer) return;
    recommendationsContainer.innerHTML = "";

    fetch("/get_questions")
      .then(res => res.json())
      .then(questions => {
        questions.forEach(q => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "rec-btn";
          btn.textContent = q;
          btn.addEventListener("click", () => {
            sendMessage(q, { fromSuggestion: true });
          });
          recommendationsContainer.appendChild(btn);
        });
      })
      .catch(err => {
        console.error("Gagal memuat rekomendasi:", err);
      });
  }

  // ----- UPDATE RECOMMENDATIONS -----
  function updateRecommendations(questions) {
    if (!recommendationsContainer) return;
    recommendationsContainer.innerHTML = "";
    (questions || []).forEach(q => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "rec-btn";
      btn.textContent = q;
      btn.addEventListener("click", () => {
        sendMessage(q, { fromSuggestion: true });
      });
      recommendationsContainer.appendChild(btn);
    });
  }

  // ----- SENDING & SUBMIT -----
  function sendMessage(text, opts = {}) {
    if (!text || !text.toString().trim()) return;
    appendMessage(PERSON_NAME, PERSON_IMG, "right", text);
    msgerInput.value = "";
    botResponse(text, opts);
  }

  msgerForm.addEventListener("submit", event => {
    event.preventDefault();
    const msgText = msgerInput.value.trim();
    if (!msgText) return;
    sendMessage(msgText, { fromSuggestion: false });
  });

  // ----- FORMAT RESPONSE -----
  function formatResponse(response) {
    // jika object dengan sections (multi intro + points)
    if (typeof response === "object" && response.sections) {
      return response.sections.map(section => {
        let html = "";
        if (section.intro) html += `<p>${section.intro}</p>`;
        if (section.points && Array.isArray(section.points)) {
          html += "<ul>";
          section.points.forEach(item => {
            html += `<li>${item}</li>`;
          });
          html += "</ul>";
        }
        return html;
      }).join("");
    }

    // jika object dengan intro + points tunggal
    if (typeof response === "object" && response.intro) {
      let html = `<p>${response.intro}</p>`;
      if (response.points && Array.isArray(response.points)) {
        html += "<ul>";
        response.points.forEach(item => {
          html += `<li>${item}</li>`;
        });
        html += "</ul>";
      }
      return html;
    }

    // jika array biasa
    if (Array.isArray(response)) {
      let list = "<ul>";
      response.forEach(item => {
        list += `<li>${item}</li>`;
      });
      list += "</ul>";
      return list;
    }

    // fallback: string biasa
    return `<p>${response}</p>`;
  }

  // ----- APPEND MESSAGE -----
  function appendMessage(name, img, side, text) {
    const msgHTML = `
      <div class="msg ${side}-msg">
        <div class="msg-img" style="background-image: url(${img})"></div>
        <div class="msg-bubble">
          <div class="msg-info">
            <div class="msg-info-name">${name}</div>
            <div class="msg-info-time">${formatDate(new Date())}</div>
          </div>
          <div class="msg-text">${text}</div>
        </div>
      </div>`;
    msgerChat.insertAdjacentHTML("beforeend", msgHTML);
    msgerChat.scrollTop = msgerChat.scrollHeight;
  }

  // ----- BOT RESPONSE -----
  function botResponse(rawText, opts = {}) {
  $.get("/get", { msg: rawText })
    .done(function (data) {
      // data.response = array; tiap item bisa string atau object
      const items = Array.isArray(data.response) ? data.response : [data.response];

      items.forEach(item => {
        // langsung gunakan formatter (support string / {intro,points} / {sections})
        const botHtml = formatResponse(item);
        appendMessage(BOT_NAME, BOT_IMG, "left", botHtml);
      });

      // update rekomendasi
      if (data && Array.isArray(data.recommendations)) {
        updateRecommendations(data.recommendations);
      }
    })
    .fail(function () {
      appendMessage(BOT_NAME, BOT_IMG, "left", "Maaf, terjadi kesalahan pada server.");
    });
}

  // ----- UTILS -----
  function get(selector, root = document) {
    return root.querySelector(selector);
  }

  function formatDate(date) {
    const h = "0" + date.getHours();
    const m = "0" + date.getMinutes();
    return `${h.slice(-2)}:${m.slice(-2)}`;
  }
  </script>

  <footer class="footer">
    <p>&copy; 2025 Sahabat Anak.</p>
  </footer>
</body>
</html>